---
title: "Introduction to data visualization with R and ggplot2"
author: "Dr. Dominik Schmidt"
date: "`r substr((Sys.Date()),1,4)`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
    toc_depth: 4    
    css: "./custom.css"     
    code_folding: show
---
```{r echo=FALSE}

knitr::opts_chunk$set(
  class.output  = "bg-success",
  class.message = "bg-info text-info",
  class.warning = "bg-warning text-warning",
  class.error   = "bg-danger text-danger"
  )
```


# 003: Basic plot types 

- in base `ggplot2`

## Vote

- What is your most used plot type?
- scatterplot / barplot /  boxplot / lineplot / other


## Cheatsheet 

- https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf
- https://www.data-to-viz.com/



## Package installation

- Copy and paste the following code in the R-console to install necessary packages.


```{r message=FALSE}

usePackage <- function(p)   
{ 
  if (!is.element(p, installed.packages()[,1])) 
    install.packages(p, dep = TRUE, repos="https://cloud.r-project.org/", lib=.libPaths()[1]) 
  require(p, character.only = TRUE) 
} 
  
usePackage("data.table")
usePackage("ggplot2")
usePackage("rdwd")

```


# Examples

## Histograms and distributions 

- Continuous or ordinal input 

```{r}
library("ggplot2")
library("data.table")

# Counts per 'bin' 
ggplot(data=iris, aes(x=Sepal.Length))+
  geom_histogram()

ggplot(data=iris, aes(x=Sepal.Length))+
  geom_histogram(binwidth=0.1)

ggplot(data=iris, aes(x=Sepal.Length))+
  geom_histogram(binwidth=0.2
                ,aes(fill=Species)
                )

ggplot(data=iris, aes(x=Sepal.Length))+
  geom_histogram(binwidth=0.2
              , aes(fill=Species)
              , position="dodge"
              )


# 'Smoothed' histogram / Kernel density estimation
ggplot(data=iris, aes(x=Sepal.Length,color=Species))+
  geom_density()

# Rotated density
ggplot(data=iris, aes(x=Species,y=Sepal.Length))+
  geom_violin()


# Alternative histogram code
ggplot(data=iris, aes(x=Sepal.Length))+
  geom_bar()+
  scale_x_binned()

# Alternative: frequency polygons
ggplot(data=iris, aes(x=Sepal.Length, color=Species))+
  geom_freqpoly(binwidth=0.2)


```



## Scatterplot + Count

- measurement precision of iris data set = 0.1 cm
- **problem**: *overlapping* observations in scatter plot

```{r}

# original
ggplot(data=iris, aes(x=Petal.Length,y=Petal.Width))+
  geom_point()

# counts
ggplot(data=iris, aes(x=Petal.Length,y=Petal.Width))+
  geom_count()


# hex-bin 
ggplot(data=iris, aes(x=Petal.Length,y=Petal.Width))+
  geom_hex()


```


## Boxplot alternatives


- besides histogram etc...
- more in 'Advanced boxplots' (optional topic)


```{r}
# original boxplot
ggplot(data=iris, aes(x=Species,y=Petal.Width))+
  geom_boxplot()

# Rotated density
ggplot(data=iris, aes(x=Species,y=Petal.Width))+
  geom_violin()

# add quantiles
ggplot(data=iris, aes(x=Species,y=Petal.Width))+
  geom_violin(draw_quantiles=c(0.25,0.5,0.75))

# 'semi-continuous' measurement 
sort(unique(iris$Petal.Width))

ggplot(data=iris, aes(x=Species,y=Petal.Width))+
  geom_count()

# or simply the data with some 'random' x-component
ggplot(data=iris, aes(x=Species,y=Petal.Width))+
  geom_jitter(height=0, width=0.25)

```



# Bar plot

- implicitly counts occurrences of discrete variables/factors

```{r}

ggplot(data=iris, aes(x=Species))+
  geom_bar()

# automatically detects characters as 'grouping'
ggplot(data=iris, aes(x=as.character(Species)))+
  geom_bar()


```


# Bar plot and dot plot

- for counts, but also for other summary statistics
- Dataset: USArrests - arrests per 100.000 residents

```{r}
USArrests <- as.data.table(USArrests,keep.rownames = TRUE)
colnames(USArrests)[1] = "State"

# bar plot
ggplot(USArrests,aes(x = State, y = Assault)) +
    geom_col() 

# dot plot
ggplot(USArrests,aes(x = State, y = Assault)) +
    geom_point()+
    scale_y_continuous(limits=c(0,NA)                       # include zero
                      ,expand = expansion(mult = c(0, .1))) # expand top    

# rotate bar
ggplot(USArrests,aes(y = State, x = Assault)) +
    geom_col()
 
# rotate dot 
ggplot(USArrests,aes(y = State, x = Assault)) +
    geom_point()+
    scale_x_continuous(limits=c(0,NA)                       # include zero
                      ,expand = expansion(mult = c(0, .1))) # expand right


# Reorder States 
# bar    
ggplot(USArrests,aes(y = reorder(x=State,X=Assault,FUN=max), x = Assault)) +
    geom_col()+
    scale_x_continuous(limits=c(0,NA)                       # include zero
                      ,expand = expansion(mult = c(0, .1))) # expand right 


# dot
ggplot(USArrests,aes(y = reorder(x=State,X=Assault,FUN=max), x = Assault)) +
    geom_point()+
    scale_x_continuous(limits=c(0,NA)                       # include zero
                      ,expand = expansion(mult = c(0, .1))) # expand right    

```



# Time-series data

- ... or equivalents



```{r}

# load packages
# library("rdwd")
# to update to latest version
# updateRdwd() 

##########################################################################################
# DO NOT EXECUTE CODE IN BINDER !
##########################################################################################
# #Select data from the DWD CDC FTP Server
# #set current=TRUE - to check current FTP Server Index to gather up-to-date file information
# link <- selectDWD("Geisenheim", res="daily", var="kl", per="recent", current=FALSE)
# #Download data from the DWD CDC FTP Server
# file <- dataDWD(link, read=FALSE, dir="DWDdata", quiet=TRUE, force=NA)
# #Process data from the DWD CDC FTP Server to a data.frame
# clim <- readDWD(file, varnames=TRUE, fread=TRUE)

# # Write out for students 
# fwrite(clim,"clim_DWD_Geisenheim_current.csv")
##########################################################################################
# Read file (for BINDER USERS)
##########################################################################################
clim <- fread("clim_DWD_Geisenheim_current.csv")
clim[,"MESS_DATUM":=as.POSIXct(MESS_DATUM)] 
##########################################################################################

str(clim)

summary(clim)



#MESS_DATUM  = Measurement Date
#TMK.Lufttemperatur = Daily Mean Air Temperature 2 m above ground 

# Time frame [first and last value of 'MESS_DATUM']
clim[c(1,nrow(clim)),"MESS_DATUM"]

# Scatterplot air temperature over time

ggplot(data=clim, aes(x=MESS_DATUM, y=TMK.Lufttemperatur))+
  geom_point()

# Line plot

ggplot(data=clim, aes(x=MESS_DATUM, y=TMK.Lufttemperatur))+
  geom_line()


# 'introduce' missing data 
nrow(clim)

ggplot(data=clim[-c(100:150),], aes(x=MESS_DATUM, y=TMK.Lufttemperatur))+
  geom_point()

# not do
ggplot(data=clim[-c(100:150),], aes(x=MESS_DATUM, y=TMK.Lufttemperatur))+
  geom_line()

# combine plots
ggplot(data=clim[-c(100:150),], aes(x=MESS_DATUM, y=TMK.Lufttemperatur))+
  geom_point()+
  geom_line()  


```




# High density scatterplots

- binning to account for overlaps
- no 'discrete' overlaps (no truncation of floating point numbers)

```{r}
set.seed(1) #fix random sampling with 'seed'
dRandom <- data.table( 
                        x=rnorm(n=1000,mean=0,sd=0.5),
                        y=rnorm(n=1000,mean=0,sd=0.5)
                      )
ggplot(dRandom, aes(x=x, y=y))+
  geom_point()

# binning
# hex (automatic)
ggplot(dRandom, aes(x=x, y=y))+
  geom_hex()

# box (automatic)
ggplot(dRandom, aes(x=x, y=y))+
  geom_bin2d()

# density (automatic)
ggplot(dRandom, aes(x=x, y=y))+
  geom_density_2d_filled()

# count (manual; round data)
ggplot(dRandom, aes(x=round(x,1), y=round(y,1)))+
  geom_count()

```



- see also https://github.com/LKremer/ggpointdensity









# Exercise

- Create different visualization of the distribution of daily mean air temperature (`TMK.Lufttemperatur`) using density, histogram and frequency polygon plots
- Play around with their options (density: `adjust=`, histogram and frequency polygon: `binwidth=`)
- more options can be found in the help of the respective `?geom_...`



# Additional resources


- http://www.sthda.com/english/wiki/ggplot2-essentials
- https://www.data-to-viz.com/
- http://www.chadskelton.com/2018/06/bar-charts-should-always-start-at-zero.html
- http://www.chadskelton.com/2015/12/in-defence-of-data-visualization-rules.html
- https://arxiv.org/pdf/1907.02035.pdf
- https://www.vis4.net/blog/2019/05/line-chart-y-axis/
- https://youtu.be/14VYnFhBKcY (Shut up about the y-axis. It shouldnâ€™t always start at zero.)
- https://github.com/LKremer/ggpointdensity
- https://ggplot2.tidyverse.org/reference/geom_density_2d.html

#  Session Info

```{r}

sessionInfo()

```
